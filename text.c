#include "text.h"
#include <stdlib.h>
#include <GL/glew.h>
#include <stdbool.h>
#include "gpu.h"

static unsigned int* text_ui_texture_array = NULL;
GLuint textTexture;
GLuint textShaderProgram;
unsigned int W;
unsigned int H;
static bool dirty = false;
const char FONT[HICHAR-LOCHAR+1][FONT_HEIGHT] = {
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },{ 0x00,0x00,0x00,0x00,0x02,0x02,0x00,0x02 },{ 0x00,0x00,0x00,0x00,0x05,0x05,0x00,0x00 },{ 0x00,0x00,0x00,0x00,0x06,0x0F,0x0F,0x06 },{ 0x00,0x00,0x00,0x00,0x02,0x07,0x07,0x02 },{ 0x00,0x00,0x00,0x00,0x09,0x04,0x02,0x09 },{ 0x00,0x00,0x00,0x00,0x03,0x0D,0x07,0x0B },{ 0x00,0x00,0x00,0x00,0x04,0x02,0x00,0x00 },{ 0x00,0x00,0x00,0x00,0x04,0x02,0x02,0x04 },{ 0x00,0x00,0x00,0x00,0x02,0x04,0x04,0x02 },{ 0x00,0x00,0x00,0x00,0x02,0x07,0x02,0x05 },{ 0x00,0x00,0x00,0x00,0x00,0x02,0x07,0x02 },{ 0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x04 },{ 0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00 },{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02 },{ 0x00,0x00,0x00,0x00,0x04,0x04,0x02,0x02 },{ 0x00,0x00,0x00,0x00,0x07,0x05,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x03,0x02,0x02,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x04,0x03,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x06,0x04,0x07 },{ 0x00,0x00,0x00,0x00,0x05,0x05,0x07,0x04 },{ 0x00,0x00,0x00,0x00,0x07,0x03,0x04,0x07 },{ 0x00,0x00,0x00,0x00,0x03,0x01,0x07,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x04,0x02,0x02 },{ 0x00,0x00,0x00,0x00,0x06,0x07,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x07,0x04,0x06 },{ 0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x02 },{ 0x00,0x00,0x00,0x00,0x02,0x00,0x06,0x04 },{ 0x00,0x00,0x00,0x00,0x00,0x04,0x02,0x04 },{ 0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x07 },{ 0x00,0x00,0x00,0x00,0x00,0x02,0x04,0x02 },{ 0x00,0x00,0x00,0x00,0x07,0x06,0x00,0x02 },{ 0x00,0x00,0x00,0x00,0x0F,0x09,0x0A,0x0F },{ 0x00,0x00,0x00,0x00,0x06,0x05,0x07,0x05 },{ 0x00,0x00,0x00,0x00,0x03,0x07,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x06,0x01,0x01,0x07 },{ 0x00,0x00,0x00,0x00,0x03,0x05,0x05,0x03 },{ 0x00,0x00,0x00,0x00,0x07,0x03,0x01,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x03,0x01,0x01 },{ 0x00,0x00,0x00,0x00,0x06,0x01,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x05,0x05,0x07,0x05 },{ 0x00,0x00,0x00,0x00,0x07,0x02,0x02,0x07 },{ 0x00,0x00,0x00,0x00,0x06,0x04,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x05,0x03,0x03,0x05 },{ 0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x07,0x07,0x05 },{ 0x00,0x00,0x00,0x00,0x07,0x05,0x05,0x05 },{ 0x00,0x00,0x00,0x00,0x07,0x05,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x05,0x07,0x01 },{ 0x00,0x00,0x00,0x00,0x07,0x05,0x07,0x0F },{ 0x00,0x00,0x00,0x00,0x07,0x05,0x03,0x05 },{ 0x00,0x00,0x00,0x00,0x07,0x01,0x06,0x07 },{ 0x00,0x00,0x00,0x00,0x07,0x02,0x02,0x02 },{ 0x00,0x00,0x00,0x00,0x05,0x05,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x05,0x05,0x03,0x01 },{ 0x00,0x00,0x00,0x00,0x05,0x07,0x07,0x07 },{ 0x00,0x00,0x00,0x00,0x05,0x02,0x05,0x05 },{ 0x00,0x00,0x00,0x00,0x05,0x07,0x02,0x02 },{ 0x00,0x00,0x00,0x00,0x07,0x04,0x02,0x07 },{ 0x00,0x00,0x00,0x00,0x06,0x02,0x02,0x06 },{ 0x00,0x00,0x00,0x00,0x02,0x02,0x04,0x04 },{ 0x00,0x00,0x00,0x00,0x06,0x04,0x04,0x06 },{ 0x00,0x00,0x00,0x00,0x02,0x05,0x00,0x00 },{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F },{ 0x00,0x00,0x00,0x00,0x01,0x02,0x00,0x00 },{ 0x00,0x00,0x00,0x00,0x00,0x06,0x07,0x07 },{ 0x00,0x00,0x00,0x00,0x01,0x07,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x00,0x06,0x01,0x07 },{ 0x00,0x00,0x00,0x00,0x04,0x07,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x00,0x07,0x07,0x03 },{ 0x00,0x00,0x00,0x00,0x06,0x02,0x07,0x02 },{ 0x00,0x00,0x00,0x00,0x06,0x07,0x04,0x03 },{ 0x00,0x00,0x00,0x00,0x01,0x07,0x05,0x05 },{ 0x00,0x00,0x00,0x00,0x02,0x00,0x02,0x02 },{ 0x00,0x00,0x00,0x00,0x02,0x00,0x02,0x03 },{ 0x00,0x00,0x00,0x00,0x01,0x05,0x03,0x05 },{ 0x00,0x00,0x00,0x00,0x03,0x02,0x02,0x06 },{ 0x00,0x00,0x00,0x00,0x00,0x07,0x07,0x05 },{ 0x00,0x00,0x00,0x00,0x00,0x07,0x05,0x05 },{ 0x00,0x00,0x00,0x00,0x00,0x07,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x02,0x05,0x03,0x01 },{ 0x00,0x00,0x00,0x00,0x02,0x05,0x06,0x04 },{ 0x00,0x00,0x00,0x00,0x00,0x07,0x01,0x01 },{ 0x00,0x00,0x00,0x00,0x00,0x06,0x02,0x03 },{ 0x00,0x00,0x00,0x00,0x02,0x06,0x02,0x06 },{ 0x00,0x00,0x00,0x00,0x00,0x05,0x05,0x07 },{ 0x00,0x00,0x00,0x00,0x00,0x05,0x07,0x02 },{ 0x00,0x00,0x00,0x00,0x00,0x05,0x07,0x07 },{ 0x00,0x00,0x00,0x00,0x00,0x05,0x02,0x05 },{ 0x00,0x00,0x00,0x00,0x00,0x05,0x06,0x03 },{ 0x00,0x00,0x00,0x00,0x00,0x03,0x02,0x06 },{ 0x00,0x00,0x00,0x00,0x06,0x03,0x02,0x06 },{ 0x00,0x00,0x00,0x00,0x02,0x02,0x02,0x02 },{ 0x00,0x00,0x00,0x00,0x03,0x06,0x02,0x03 },{ 0x00,0x00,0x00,0x00,0x04,0x07,0x01,0x00 },};

bool init_text_ui(unsigned int w, unsigned int h) {
    W = w;
    H = h;

    if(text_ui_texture_array){
        free(text_ui_texture_array);
    }
    text_ui_texture_array = (unsigned int*)malloc(W * H * sizeof(unsigned int));
    for (unsigned i = 0; i < W * H; i++) text_ui_texture_array[i] = 0x00000000;
    
    glGenTextures(1, &textTexture);
    glBindTexture(GL_TEXTURE_2D, textTexture);
    glEnable(GL_BLEND);
    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
    glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, W, H, 0, GL_RGBA, GL_UNSIGNED_BYTE, text_ui_texture_array);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);

    textShaderProgram = LoadShader("textui.vert.glsl", "textui.frag.glsl");
    return true;
}

void free_text_ui(){
    free(text_ui_texture_array);
}

void draw_char(char c, int x, int y) {
    if (c < LOCHAR || c >= HICHAR) c = '!';

    const char *bitmap = FONT[c - LOCHAR];
    for (int row = 0; row < FONT_HEIGHT; row++) {
        unsigned int byte = bitmap[row];
        int row_offset = (8*y + row) * W;
        for (int col = 0; col < 8; col++) {
            text_ui_texture_array[row_offset + 5*x + col] = byte & (1 << col) ? 0xFFFFFFFF : 0x00000000;
        }
    }
}

// Draw a string
void draw_text(const char *text, int x, int y) {
    int orig_x = x;
    while (*text) {
        if (*text == '\n') {
            ++y;
            x = orig_x;
        } else {
            draw_char(*text, x, y);
            ++x;
        }
        ++text;
    }
    dirty = true;
}

void debug_draw_all_chars(int x, int y) {
    int start_x = x;
    for(char c = ' '; c < 127; c++){
        draw_char(c, x++, y);
        if(x==8){
            x = start_x;
            ++y;
        }
    }
    dirty = true;
}

unsigned int render_text(){
    if(dirty){
        glBindTexture(GL_TEXTURE_2D, textTexture);
        glTexSubImage2D(GL_TEXTURE_2D, 0, 0, 0, W, H, GL_RGBA, GL_UNSIGNED_BYTE, text_ui_texture_array);
    }
    
    glUseProgram(textShaderProgram);
    glActiveTexture(GL_TEXTURE0);
    glBindTexture(GL_TEXTURE_2D, textTexture);
    glUniform1i(glGetUniformLocation(textShaderProgram, "textTexture"), 0);
    glDrawArrays(GL_TRIANGLES, 0, 6);
    return 0;
}
